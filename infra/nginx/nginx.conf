worker_processes auto;
events { worker_connections 1024; }

http {
  server {
    listen 80;
    server_name _;

    # Trailing slash (evita 404 de assets/links)erset:
    location = /superset   { return 301 /superset/; }
    location = /airflow    { return 301 /airflow/; }
    location = /prometheus { return 301 /prometheus/; }
    location = /minio      { return 301 /minio/; }

    # -------- Superset em /superset --------
    location /superset/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade            $http_upgrade;
      proxy_set_header Connection         "upgrade";
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
      proxy_set_header X-Forwarded-Prefix /superset;
      proxy_redirect off;
      proxy_pass http://superset:8088/;   # barra final IMPORTANTE
    }

    # -------- Airflow em /airflow --------
    location /airflow/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade            $http_upgrade;
      proxy_set_header Connection         "upgrade";
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
      proxy_set_header X-Forwarded-Prefix /airflow;
      proxy_redirect off;
      proxy_pass http://airflow-webserver:8080/;
    }

    # -------- Prometheus em /prometheus --------
    # (Prometheus precisa dos flags no compose)
    location /prometheus/ {
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
      proxy_redirect off;
      proxy_pass http://prometheus:9090/;
    }

    # -------- MinIO Console em /minio --------
    # Console não respeita subpath; removemos o prefixo.
    location /minio/ {
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
      proxy_redirect off;

      rewrite ^/minio/(.*)$ /$1 break;    # tira /minio/ do início
      proxy_pass http://minio:9001;       # SEM barra final
    }

    # raiz (opcional)
    location = / { return 302 /superset/; }
  }
}
